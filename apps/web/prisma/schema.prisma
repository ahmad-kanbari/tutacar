generator client {
  provider        = "prisma-client-js"
}

datasource db {
  provider   = "postgresql"
}

enum Role {
  driver
  mechanic
  admin
}

enum VerificationStatus {
  pending
  verified
  rejected
}

enum SubscriptionTier {
  free
  pro
  premium
}

enum BookingStatus {
  requested
  accepted
  in_progress
  completed
  cancelled
}

enum PaymentStatus {
  pending
  paid
  refunded
}

enum ReminderType {
  oil_change
  tire_rotation
  brake_inspection
  general
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  password_hash   String
  role            Role
  full_name       String
  phone_number    String
  profile_photo_url String?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  is_verified     Boolean   @default(false)
  fcm_token       String?

  driver            Driver?
  mechanic          Mechanic?
  sent_messages     Message[] @relation("SentMessages")
  received_messages Message[] @relation("ReceivedMessages")
  loyalty_points    LoyaltyPoints?
  referrals_made    Referral[] @relation("Referrals")
  referrals_received Referral[] @relation("Referees")
  article_bookmarks ArticleBookmark[]
  notifications     Notification[]
  payment_methods   PaymentMethod[]
  shop_memberships  ShopMember[]

  @@map("users")
}

model Driver {
  id              String    @id @default(uuid())
  user_id         String    @unique
  user            User      @relation(fields: [user_id], references: [id])
  // current_location Unsupported("geometry(Point, 4326)")? // Using generic location for now to avoid complexity if PostGIS isn't set up, but following prompt requirement
  current_location_lat Float?
  current_location_lng Float?
  preferred_language String?
  emergency_contact_name String?
  emergency_contact_phone String?

  vehicles         Vehicle[]
  bookings         Booking[]
  reviews          Review[]
  emergency_requests EmergencyRequest[]
  saved_mechanics  SavedMechanic[]

  @@map("drivers")
}

model Mechanic {
  id              String    @id @default(uuid())
  user_id         String    @unique
  user            User      @relation(fields: [user_id], references: [id])
  shop_name       String
  shop_address    String
  shop_description String?
  // shop_location   Unsupported("geometry(Point, 4326)")?
  shop_location_lat Float?
  shop_location_lng Float?
  service_radius_km Float?
  certifications  String[]
  specializations String[]
  years_experience Int?
  hourly_rate     Decimal?
  is_available    Boolean   @default(true)
  working_hours   Json?
  rating_average  Decimal   @default(0)
  total_reviews   Int       @default(0)
  verification_status VerificationStatus @default(pending)
  subscription_tier SubscriptionTier @default(free)

  bookings         Booking[]
  reviews          Review[]
  emergency_requests EmergencyRequest[]
  saved_by         SavedMechanic[]
  shop_photos      ShopPhoto[]
  services         MechanicService[]
  team_members     ShopMember[]
  shop_invitations ShopInvitation[]

  @@map("mechanics")
}

enum ShopRole {
  ADMIN
  SUB_ADMIN
}

model ShopMember {
  id          String   @id @default(uuid())
  mechanic_id String
  mechanic    Mechanic @relation(fields: [mechanic_id], references: [id])
  user_id     String
  user        User     @relation(fields: [user_id], references: [id])
  role        ShopRole @default(SUB_ADMIN)
  joined_at   DateTime @default(now())

  @@map("shop_members")
}

model ShopInvitation {
  id          String   @id @default(uuid())
  mechanic_id String
  mechanic    Mechanic @relation(fields: [mechanic_id], references: [id])
  email       String
  role        ShopRole @default(SUB_ADMIN)
  token       String   @unique @default(uuid())
  created_at  DateTime @default(now())
  expires_at  DateTime

  @@unique([mechanic_id, email])
  @@map("shop_invitations")
}

model MechanicService {
  id          String   @id @default(uuid())
  mechanic_id String
  mechanic    Mechanic @relation(fields: [mechanic_id], references: [id])
  name        String
  description String?
  price       Decimal
  duration_min Int
  is_active   Boolean  @default(true)
  
  @@map("mechanic_services")
}

model Vehicle {
  id              String    @id @default(uuid())
  driver_id       String
  driver          Driver    @relation(fields: [driver_id], references: [id])
  make            String
  model           String
  year            Int
  color           String?
  license_plate   String?
  current_mileage Int?
  last_service_date DateTime?
  vin_number      String?

  bookings        Booking[]
  reminders       MaintenanceReminder[]

  @@map("vehicles")
}

model Booking {
  id              String    @id @default(uuid())
  driver_id       String
  driver          Driver    @relation(fields: [driver_id], references: [id])
  mechanic_id     String
  mechanic        Mechanic  @relation(fields: [mechanic_id], references: [id])
  vehicle_id      String
  vehicle         Vehicle   @relation(fields: [vehicle_id], references: [id])
  service_type    String
  description     String?
  issue_photos    String[]
  status          BookingStatus @default(requested)
  scheduled_time  DateTime?
  // location        Unsupported("geometry(Point, 4326)")?
  location_lat    Float?
  location_lng    Float?
  location_address String?
  estimated_price Decimal?
  final_price     Decimal?
  payment_status  PaymentStatus @default(pending)
  created_at      DateTime  @default(now())
  completed_at    DateTime?
  accepted_at     DateTime?
  started_at      DateTime?

  reviews         Review[]
  messages        Message[]
  payments        Payment[]

  @@map("bookings")
}

model Review {
  id              String    @id @default(uuid())
  booking_id      String
  booking         Booking   @relation(fields: [booking_id], references: [id])
  driver_id       String
  driver          Driver    @relation(fields: [driver_id], references: [id])
  mechanic_id     String
  mechanic        Mechanic  @relation(fields: [mechanic_id], references: [id])
  rating          Int
  comment         String?
  photos          String[] // Before/after photos
  helpful_count   Int       @default(0)
  created_at      DateTime  @default(now())

  categories      ReviewCategory?
  tags            ReviewTag[]
  response        ReviewResponse?

  @@map("reviews")
}

model Message {
  id              String    @id @default(uuid())
  booking_id      String
  booking         Booking   @relation(fields: [booking_id], references: [id])
  sender_id       String
  sender          User      @relation("SentMessages", fields: [sender_id], references: [id])
  receiver_id     String
  receiver        User      @relation("ReceivedMessages", fields: [receiver_id], references: [id])
  message_text    String?
  media_urls      String[]
  is_read         Boolean   @default(false)
  created_at      DateTime  @default(now())

  @@map("messages")
}

model MaintenanceReminder {
  id              String    @id @default(uuid())
  vehicle_id      String
  vehicle         Vehicle   @relation(fields: [vehicle_id], references: [id])
  reminder_type   ReminderType
  due_date        DateTime?
  due_mileage     Int?
  is_completed    Boolean   @default(false)
  notes           String?
  created_at      DateTime  @default(now())

  @@map("maintenance_reminders")
}

// Loyalty & Referral System
model LoyaltyPoints {
  id              String    @id @default(uuid())
  user_id         String    @unique
  user            User      @relation(fields: [user_id], references: [id])
  total_points    Int       @default(0)
  tier_level      String    @default("Bronze") // Bronze, Silver, Gold, Platinum
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  transactions    PointTransaction[]

  @@map("loyalty_points")
}

model PointTransaction {
  id              String    @id @default(uuid())
  loyalty_id      String
  loyalty         LoyaltyPoints @relation(fields: [loyalty_id], references: [id])
  points          Int // Positive for earn, negative for redeem
  action_type     String // booking_completed, review_left, referral, redeemed
  description     String?
  created_at      DateTime  @default(now())

  @@map("point_transactions")
}

model Referral {
  id              String    @id @default(uuid())
  referrer_id     String
  referrer        User      @relation("Referrals", fields: [referrer_id], references: [id])
  referee_email   String
  referee_id      String?
  referee         User?     @relation("Referees", fields: [referee_id], references: [id])
  referral_code   String    @unique
  status          String    @default("pending") // pending, signed_up, completed
  reward_given    Boolean   @default(false)
  created_at      DateTime  @default(now())
  completed_at    DateTime?

  @@map("referrals")
}

// Educational Content
model Article {
  id              String    @id @default(uuid())
  title           String
  slug            String    @unique
  content         String
  excerpt         String?
  thumbnail_url   String?
  category        String // Basics, Warning Lights, Maintenance, Troubleshooting, Seasonal Care
  read_time_minutes Int
  author          String    @default("CarConnect Team")
  is_published    Boolean   @default(false)
  view_count      Int       @default(0)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  bookmarks       ArticleBookmark[]

  @@map("articles")
}

model ArticleBookmark {
  id              String    @id @default(uuid())
  user_id         String
  user            User      @relation(fields: [user_id], references: [id])
  article_id      String
  article         Article   @relation(fields: [article_id], references: [id])
  created_at      DateTime  @default(now())

  @@unique([user_id, article_id])
  @@map("article_bookmarks")
}

// Enhanced Reviews with categories
model ReviewCategory {
  id              String    @id @default(uuid())
  review_id       String
  review          Review    @relation(fields: [review_id], references: [id])
  quality_rating  Int // 1-5
  punctuality_rating Int // 1-5
  communication_rating Int // 1-5
  pricing_rating  Int // 1-5
  cleanliness_rating Int? // 1-5

  @@unique([review_id])
  @@map("review_categories")
}

model ReviewTag {
  id              String    @id @default(uuid())
  review_id       String
  review          Review    @relation(fields: [review_id], references: [id])
  tag             String // great_explanation, fixed_quickly, fair_price, went_above_beyond

  @@map("review_tags")
}

model ReviewResponse {
  id              String    @id @default(uuid())
  review_id       String    @unique
  review          Review    @relation(fields: [review_id], references: [id])
  response_text   String
  created_at      DateTime  @default(now())

  @@map("review_responses")
}

// Emergency Services
model EmergencyRequest {
  id              String    @id @default(uuid())
  driver_id       String
  driver          Driver    @relation(fields: [driver_id], references: [id])
  location_lat    Float
  location_lng    Float
  location_address String?
  issue_description String?
  status          String    @default("pending") // pending, accepted, en_route, completed, cancelled
  assigned_mechanic_id String?
  assigned_mechanic Mechanic? @relation(fields: [assigned_mechanic_id], references: [id])
  created_at      DateTime  @default(now())
  accepted_at     DateTime?
  completed_at    DateTime?

  @@map("emergency_requests")
}

// Notifications
model Notification {
  id              String    @id @default(uuid())
  user_id         String
  user            User      @relation(fields: [user_id], references: [id])
  title           String
  message         String
  type            String // booking, payment, reminder, message, emergency
  related_id      String? // ID of related booking, message, etc.
  is_read         Boolean   @default(false)
  created_at      DateTime  @default(now())

  @@map("notifications")
}

// Saved Mechanics
model SavedMechanic {
  id              String    @id @default(uuid())
  driver_id       String
  driver          Driver    @relation(fields: [driver_id], references: [id])
  mechanic_id     String
  mechanic        Mechanic  @relation(fields: [mechanic_id], references: [id])
  created_at      DateTime  @default(now())

  @@unique([driver_id, mechanic_id])
  @@map("saved_mechanics")
}

// Payment Methods
model PaymentMethod {
  id              String    @id @default(uuid())
  user_id         String
  user            User      @relation(fields: [user_id], references: [id])
  type            String // card, bank_account
  last_four       String
  brand           String? // visa, mastercard, etc.
  stripe_payment_method_id String
  is_default      Boolean   @default(false)
  created_at      DateTime  @default(now())

  @@map("payment_methods")
}

// Payment History
model Payment {
  id              String    @id @default(uuid())
  booking_id      String
  booking         Booking   @relation(fields: [booking_id], references: [id])
  stripe_payment_intent_id String
  amount          Decimal
  commission_amount Decimal   @default(0)
  mechanic_amount Decimal     @default(0)
  currency        String    @default("usd")
  status          PaymentStatus
  created_at      DateTime  @default(now())
  paid_at         DateTime?

  @@map("payments")
}

// Mechanic Shop Photos
model ShopPhoto {
  id              String    @id @default(uuid())
  mechanic_id     String
  mechanic        Mechanic  @relation(fields: [mechanic_id], references: [id])
  photo_url       String
  caption         String?
  display_order   Int       @default(0)
  created_at      DateTime  @default(now())

  @@map("shop_photos")
}
